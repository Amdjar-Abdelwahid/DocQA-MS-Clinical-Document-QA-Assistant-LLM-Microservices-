version: '3.8'

services:
  # 1. Base de donn√©es (Postgres)
  postgres:
    image: postgres:15
    container_name: postgres-db
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: adminpassword
      POSTGRES_DB: ingestion_db
    ports:
      - "5433:5432" # Accessible sur le port 5433 de votre PC
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d ingestion_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. Bus de Messages (RabbitMQ) - C'est lui qui manquait !
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq-bus
    ports:
      - "5672:5672"   # Port pour les scripts Python
      - "15672:15672" # Interface d'administration
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 3. Extraction de texte (Tika)
  tika:
    image: apache/tika
    container_name: tika-server
    ports:
      - "9998:9998"

  # 4. Votre service existant (Optionnel pour le moment)
  synthese-comparative:
    build:
      context: ./synthese-comparative
    container_name: synthese-comparative
    ports:
      - "8005:8005"
    environment:
      USE_FAKE_RETRIEVAL: "false"
      USE_FAKE_LLM: "false"
      SEMANTIC_INDEXER_URL: "http://semantic-indexer:8003"
      LLM_QA_URL: "http://llm-qa:8004"